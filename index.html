<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MenuVista • AR Viewer</title>

<script type="module"
  src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0b10;color:#fff}
model-viewer{width:100vw;height:100vh;background:#0b0b10}

.panel{
position:absolute;left:14px;right:14px;bottom:14px;
background:rgba(0,0,0,.55);
border-radius:18px;padding:14px;
display:flex;gap:12px;align-items:flex-end;justify-content:space-between
}

.title{font-size:18px;font-weight:900;margin:0 0 6px}
.price{color:#FF7A2F;font-weight:900}
button{border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
.primary{background:#FF7A2F;color:#111}
.ghost{background:rgba(255,255,255,.1);color:#fff}
.wa{background:#25D366;color:#111}

.modal{
position:fixed;inset:0;background:rgba(0,0,0,.6);
display:none;align-items:center;justify-content:center
}
.modal.show{display:flex}

.modal-card{
background:#111;padding:18px;border-radius:18px;
width:92%;max-width:420px
}
.box{background:rgba(255,255,255,.05);padding:12px;border-radius:14px;margin-top:12px}
.small{opacity:.8;font-size:13px}
</style>
</head>

<body>

<model-viewer id="mv"
src=""
camera-controls auto-rotate ar ar-modes="webxr scene-viewer quick-look"
shadow-intensity="1"></model-viewer>

<div class="panel">
<div>
<p class="title" id="dishName"></p>
<p class="price" id="dishPrice"></p>
</div>

<div style="display:flex;gap:8px">
<button class="ghost" id="addCart">Add</button>
<button class="wa" id="openCart">Cart</button>
<button class="primary" id="btnAR">View in AR</button>
</div>
</div>

<!-- CHECKOUT MODAL -->
<div class="modal" id="checkoutModal">
<div class="modal-card">
<h3>Checkout</h3>

<div id="cartItems"></div>
<div style="margin-top:8px;font-weight:900">Total: KSh <span id="cartTotal">0</span></div>

<!-- STK PUSH -->
<div class="box">
<div style="font-weight:900">Pay via M-Pesa STK Push</div>
<div class="small">Enter phone and tap Pay</div>

<input id="stkPhone" placeholder="07XXXXXXXX"
style="width:100%;margin-top:8px;padding:10px;border-radius:10px;border:none;background:#222;color:#fff;font-weight:900">

<button class="primary" id="stkPayBtn" style="width:100%;margin-top:8px">Pay Now (STK)</button>
<div class="small" id="stkStatus" style="margin-top:6px"></div>
</div>

<button class="ghost" style="width:100%;margin-top:10px"
onclick="document.getElementById('checkoutModal').classList.remove('show')">
Close</button>

</div>
</div>

<script>

// ===== CONFIG =====
const BACKEND_BASE="http://localhost:8081"; // change after deploy

// ===== DISHES =====
const dishes=[
{ id:"burger",name:"Burger",price:850,model:"models/burger.glb"},
{ id:"fries",name:"Fries",price:350,model:"models/fries.glb"},
{ id:"chicken",name:"Chicken",price:900,model:"models/chicken.glb"}
];

// ===== ELEMENTS =====
const mv=document.getElementById("mv");
const dishName=document.getElementById("dishName");
const dishPrice=document.getElementById("dishPrice");
const btnAR=document.getElementById("btnAR");
const addCart=document.getElementById("addCart");
const openCart=document.getElementById("openCart");
const cartItems=document.getElementById("cartItems");
const cartTotal=document.getElementById("cartTotal");
const modal=document.getElementById("checkoutModal");
const stkPhone=document.getElementById("stkPhone");
const stkPayBtn=document.getElementById("stkPayBtn");
const stkStatus=document.getElementById("stkStatus");

// ===== LOAD DISH FROM URL =====
const id=new URLSearchParams(location.search).get("dish")||dishes[0].id;
let current=dishes.find(d=>d.id===id)||dishes[0];

mv.src=current.model;
dishName.textContent=current.name;
dishPrice.textContent="KSh "+current.price;

// ===== CART =====
let cart=[];

addCart.onclick=()=>{
cart.push(current);
alert(current.name+" added");
};

openCart.onclick=()=>{
renderCart();
modal.classList.add("show");
};

function renderCart(){
cartItems.innerHTML="";
let total=0;

cart.forEach(d=>{
total+=d.price;
cartItems.innerHTML+=`<div>${d.name} — KSh ${d.price}</div>`;
});

cartTotal.textContent=total;

// STK LOGIC
stkStatus.textContent="";
stkPayBtn.onclick=async()=>{
try{
const phone=stkPhone.value.trim();
if(!phone){stkStatus.textContent="Enter phone";return;}

stkStatus.textContent="Sending STK...";
stkPayBtn.disabled=true;

const res=await fetch(`${BACKEND_BASE}/api/mpesa/stkpush`,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
phone,
amount:total,
accountReference:"MenuVista",
transactionDesc:"MenuVista"
})
});

const data=await res.json();

if(!data.ok){
stkStatus.textContent="STK failed";
stkPayBtn.disabled=false;
return;
}

stkStatus.textContent="STK sent. Check phone.";

}catch(e){
stkStatus.textContent="Backend not reachable";
stkPayBtn.disabled=false;
}
};
}

// ===== AR BUTTON =====
btnAR.onclick=()=>mv.activateAR();

</script>
</body>
</html>
