<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MenuVista • AR Viewer</title>

  <script type="module"
    src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
  </script>

  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#0b0b10; color:#fff; }
    model-viewer{
      width:100vw; height:100vh;
      background:
        radial-gradient(1200px 700px at 50% 70%, rgba(255,122,47,.18), transparent 60%),
        radial-gradient(900px 500px at 40% 40%, rgba(58,63,159,.25), transparent 55%),
        #0b0b10;
    }
    .topbar{position:absolute;top:14px;left:14px;right:14px;display:flex;gap:10px;justify-content:space-between;pointer-events:none;z-index:5}
    .chip{pointer-events:auto;padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.10);backdrop-filter:blur(10px);font-weight:900;font-size:13px}
    .toast{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.10);backdrop-filter:blur(12px);font-size:13px;max-width:88vw;text-align:center;display:none;z-index:6}
    .toast.show{display:block}
    .panel{position:absolute;left:14px;right:14px;bottom:14px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.10);backdrop-filter:blur(12px);border-radius:18px;padding:14px;display:flex;gap:12px;align-items:flex-end;justify-content:space-between;z-index:5}
    .title{font-size:18px;font-weight:900;margin:0 0 6px}
    .meta{margin:0;opacity:.9;font-size:13px;line-height:1.35}
    .price{font-weight:900;color:#FF7A2F}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{border:0;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer;white-space:nowrap}
    .primary{background:#FF7A2F;color:#111}
    .ghost{background:rgba(255,255,255,.10);color:#fff;border:1px solid rgba(255,255,255,.14)}
    .wa{background:#25D366;color:#111}
    button[disabled]{opacity:.45;cursor:not-allowed}
    .hint{opacity:.8;font-size:12px;margin-top:6px}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="chip" onclick="location.href='index.html'" style="cursor:pointer">← Menu</div>
    <div id="supportChip" class="chip">Checking AR support…</div>
  </div>

  <model-viewer id="mv"
    src=""
    camera-controls
    auto-rotate
    rotation-per-second="20deg"
    shadow-intensity="1"
    environment-image="neutral"
    exposure="1.0"
    ar
    ar-modes="webxr scene-viewer quick-look"
    ar-placement="floor">
  </model-viewer>

  <div id="toast" class="toast show">Loading 3D model…</div>

  <div class="panel">
    <div style="max-width:58ch">
      <p class="title" id="dishName">Loading…</p>
      <p class="meta"><span class="price" id="dishPrice">—</span> <span id="dishDesc"></span></p>
      <p class="meta" id="statusText">Swipe left/right to change dishes. Tap “View in AR” to place on table.</p>
      <div class="hint" id="viewsText"></div>
    </div>
    <div class="actions">
      <button class="ghost" id="btnPrev">◀</button>
      <button class="ghost" id="btnNext">▶</button>
      <button class="ghost" id="btnReset">Reset</button>
      <button class="wa" id="btnWA">WhatsApp Order</button>
      <button class="primary" id="btnAR">View in AR</button>
    </div>
  </div>

  <script>
    // ✅ MATCHES index.html
    const dishes = [
      { id:"burger",  name:"Chicken Burger", price:"KSh 850", desc:"Grilled chicken patty with toppings", model:"models/burger.glb" },
      { id:"chicken", name:"Chicken Meal",   price:"KSh 950", desc:"Chicken dish preview",               model:"models/chicken.glb" },
      { id:"fries",   name:"Fries",          price:"KSh 350", desc:"Crispy fries",                      model:"models/fries.fbx" } // convert needed
    ];

    // CHANGE THIS to restaurant number (Kenya format, no +)
    const WHATSAPP_NUMBER = "254745482764";

    const mv = document.getElementById('mv');
    const toast = document.getElementById('toast');
    const btnAR = document.getElementById('btnAR');
    const btnReset = document.getElementById('btnReset');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnWA = document.getElementById('btnWA');
    const supportChip = document.getElementById('supportChip');
    const dishName = document.getElementById('dishName');
    const dishPrice = document.getElementById('dishPrice');
    const dishDesc = document.getElementById('dishDesc');
    const viewsText = document.getElementById('viewsText');

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    const viewsKey = (id) => `mv_views_${id}`;
    const incViews = (id) => {
      const k = viewsKey(id);
      const v = parseInt(localStorage.getItem(k) || "0", 10) + 1;
      localStorage.setItem(k, String(v));
      return v;
    };

    function setToast(msg, show=true){
      toast.textContent = msg;
      toast.classList.toggle('show', !!show);
    }
    function setSupportChip(msg){ supportChip.textContent = msg; }

    function getDishIdFromURL(){
      const p = new URLSearchParams(location.search);
      return p.get("dish") || dishes[0].id;
    }

    let currentIndex = dishes.findIndex(d => d.id === getDishIdFromURL());
    if (currentIndex < 0) currentIndex = 0;

    function updateURL(){
      const id = dishes[currentIndex].id;
      const u = new URL(location.href);
      u.searchParams.set("dish", id);
      history.replaceState({}, "", u.toString());
    }

    function loadCurrentDish(){
      const d = dishes[currentIndex];
      updateURL();

      dishName.textContent = d.name;
      dishPrice.textContent = d.price;
      dishDesc.textContent = "— " + d.desc;

      const v = incViews(d.id);
      viewsText.textContent = `${v} view${v===1?"":"s"} (this browser)`;

      setToast("Loading 3D model…", true);
      mv.src = d.model;

      const msg = `Hello, I want to order: ${d.name} (${d.price}).`;
      btnWA.onclick = () => window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, "_blank");
    }

    function prevDish(){ currentIndex = (currentIndex - 1 + dishes.length) % dishes.length; loadCurrentDish(); }
    function nextDish(){ currentIndex = (currentIndex + 1) % dishes.length; loadCurrentDish(); }

    btnPrev.addEventListener("click", prevDish);
    btnNext.addEventListener("click", nextDish);

    btnReset.addEventListener('click', () => {
      mv.cameraOrbit = "0deg 75deg 2.5m";
      mv.fieldOfView = "30deg";
    });

    btnAR.addEventListener('click', async () => {
      try { await mv.activateAR(); }
      catch(e){
        setToast("AR could not start on this device. Using 3D preview instead.", true);
        console.error(e);
      }
    });

    mv.addEventListener('load', () => setToast("", false));
    mv.addEventListener('error', () => {
      setToast("Model failed to load. Check filename/path (case-sensitive). Also fries must be GLB.", true);
      btnAR.disabled = true;
      setSupportChip("Model load error");
    });

    async function detectARSupport(){
      let webxrAR = false;
      if (navigator.xr && navigator.xr.isSessionSupported) {
        try { webxrAR = await navigator.xr.isSessionSupported('immersive-ar'); } catch(_) {}
      }
      const mvAR = !!mv.canActivateAR;

      if (webxrAR) { btnAR.disabled = false; setSupportChip("AR supported (WebXR)"); return; }
      if (isIOS)   { btnAR.disabled = !mvAR; setSupportChip(btnAR.disabled ? "AR limited on iOS" : "AR supported (iOS)"); return; }
      if (mvAR)    { btnAR.disabled = false; setSupportChip("AR available (Android)"); return; }

      btnAR.disabled = true;
      setSupportChip("AR not supported");
    }

    // SWIPE
    let startX=0, startY=0, isDown=false;
    const SWIPE_MIN=50, SWIPE_MAX_Y=80;

    mv.addEventListener("touchstart", (e)=>{
      if(!e.touches || e.touches.length!==1) return;
      isDown=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY;
    }, {passive:true});

    mv.addEventListener("touchend", (e)=>{
      if(!isDown) return; isDown=false;
      const t=e.changedTouches && e.changedTouches[0]; if(!t) return;
      const dx=t.clientX-startX, dy=t.clientY-startY;
      if(Math.abs(dy)>SWIPE_MAX_Y) return;
      if(dx>SWIPE_MIN) prevDish();
      else if(dx<-SWIPE_MIN) nextDish();
    }, {passive:true});

    // INIT
    loadCurrentDish();
    setTimeout(detectARSupport, 500);
  </script>
</body>
</html>
